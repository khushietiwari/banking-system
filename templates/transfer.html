{% extends 'base_portal.html' %}
{% load static %}

{% block page_title %}Fund Transfer{% endblock %}

{% block content %}
<style>
    .beneficiary-card {
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    position: relative;
    cursor: pointer;
    transition: all 0.2s ease;
    background: white;
}

.beneficiary-card:hover {
    border-color: #2563eb;
}

/* Selected State */
input[type="radio"]:checked + .beneficiary-card {
    border-color: #2563eb;
    background: #eaf2ff;
    box-shadow: 0 0 0 3px rgba(37,99,235,0.15);
}

.check-icon {
    position: absolute;
    top: 8px;
    right: 10px;
    font-size: 18px;
    color: #2563eb;
    opacity: 0;
}

input[type="radio"]:checked + .beneficiary-card .check-icon {
    opacity: 1;
}
</style>


<div class="row justify-content-center">
    <div class="col-lg-8">

        <div class="card border-0 shadow-sm">

            <!-- HEADER -->
            <div class="card-header bg-white py-3 border-bottom">
                <div class="d-flex align-items-center">
                    <div class="bg-primary bg-opacity-10 text-primary rounded-circle p-2 me-3">
                        <i class="fas fa-paper-plane"></i>
                    </div>
                    <h5 class="mb-0 fw-bold text-primary">Initiate Transfer</h5>
                </div>
            </div>

            <div class="card-body p-4">

                <!-- BALANCE BOX -->
                <div class="balance-box mb-4 p-4 rounded-3">
                    <div class="d-flex align-items-center">
                        <div class="balance-icon me-3">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div>
                            <small class="text-uppercase fw-semibold text-muted d-block">
                                Available Balance
                            </small>
                            <span class="balance-amount">
                                ₹{{ account.balance|floatformat:2 }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- FORM -->
                <form method="POST" id="transferForm">
                    {% csrf_token %}

                    <!-- BENEFICIARY -->
                    <div class="mb-4">
                        <label class="form-label fw-bold text-muted text-uppercase small">
                            Select Beneficiary
                        </label>

                        <div class="row g-3">

                                                    {% for beneficiary in beneficiaries %}
                        <div class="col-md-6">

                            <input type="radio"
                                name="beneficiary"
                                id="ben_{{ beneficiary.id }}"
                                value="{{ beneficiary.id }}"
                                hidden>

                            <label class="beneficiary-card p-3 w-100"
                                for="ben_{{ beneficiary.id }}">

                                <div class="d-flex align-items-center">
                                    <div class="icon-circle me-3">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold">
                                            {{ beneficiary.nickname }}
                                        </div>
                                        <small class="text-muted font-monospace">
                                            {{ beneficiary.beneficiary_account.account_number }}
                                        </small>
                                    </div>
                                </div>

                                <div class="check-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>

                            </label>

                        </div>
                        {% endfor %}


                        </div>
                    </div>

                    <!-- AMOUNT -->
                    <div class="mb-4">
                        <label class="form-label fw-bold text-muted text-uppercase small">
                            Amount (₹)
                        </label>

                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-white">₹</span>
                            <input type="number"
                                   step="0.01"
                                   class="form-control fw-semibold"
                                   id="amount"
                                   name="amount"
                                   placeholder="0.00"
                                   min="1">
                        </div>

                        <small class="text-muted">
                            Maximum ₹1,00,000 per day.
                        </small>
                    </div>

                    {% if beneficiaries %}
                    <div class="d-grid mt-4">
                        <button type="button"
                                class="btn btn-primary btn-lg py-3"
                                onclick="validateAndOpenModal()">
                            Proceed to Verify
                            <i class="fas fa-arrow-right ms-2"></i>
                        </button>
                    </div>
                    {% endif %}

                    <!-- CONFIRM MODAL -->
                    <div class="modal fade" id="confirmModal" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content border-0 shadow">

                                <div class="modal-header border-0">
                                    <h5 class="modal-title fw-bold text-primary">
                                        Confirm Transfer
                                    </h5>
                                    <button type="button"
                                            class="btn-close"
                                            data-bs-dismiss="modal"></button>
                                </div>

                                <div class="modal-body text-center py-4">
                                    <div class="mb-3 text-primary">
                                        <i class="fas fa-paper-plane fa-2x"></i>
                                    </div>

                                    <p class="text-muted small text-uppercase mb-1">
                                        You are sending
                                    </p>

                                    <h2 class="fw-bold text-primary"
                                        id="confirmAmount">₹0.00</h2>

                                    <p class="text-muted small mt-3">
                                        Please verify beneficiary details carefully.
                                    </p>
                                </div>

                                <div class="modal-footer border-0 justify-content-center pb-4">
                                    <button type="button"
                                            class="btn btn-light px-4"
                                            data-bs-dismiss="modal">
                                        Cancel
                                    </button>

                                    <button type="submit"
                                            form="transferForm"
                                            class="btn btn-primary px-5">
                                        Confirm & Send
                                    </button>
                                </div>

                            </div>
                        </div>
                    </div>

                </form>
            </div>

            <div class="card-footer bg-light text-center py-3">
                <a href="{% url 'add_beneficiary' %}"
                   class="text-decoration-none fw-semibold text-primary">
                    + Add New Beneficiary
                </a>
            </div>

        </div>
    </div>
</div>

<script>
function validateAndOpenModal() {

    const beneficiaryInputs = document.querySelectorAll('input[name="beneficiary"]');
    let selectedBeneficiary = null;

    beneficiaryInputs.forEach(input => {
        if (input.checked) {
            selectedBeneficiary = input;
        }
    });

    const amount = document.getElementById('amount').value;

    if (!selectedBeneficiary) {
        alert("Please select a beneficiary.");
        return;
    }

    if (!amount || parseFloat(amount) <= 0) {
        alert("Please enter a valid amount.");
        return;
    }

    document.getElementById('confirmAmount').innerText =
        '₹' + parseFloat(amount).toFixed(2);

    var modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    modal.show();
}
</script>


{% endblock %}
